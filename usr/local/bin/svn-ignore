#!/usr/bin/ksh

# Temporary file handling:
tmp="/tmp/svn-ignore.$$"
trap 'rm -f $tmp' EXIT
trap 'exit 2' HUP QUIT INT TERM

# Set of extensions to ignore for a directory with a LaTeX document
# (i.e. ignore all the files generated by LaTeX):
tex='*.acn
*.acr
*.alg
*.aux
*.bbl
*.blg
*.bmt
*.db
*.dvi
*.exm
*.gl[gos]
*.idx
*.ilg
*.ist
*.ind
*.lof
*.log
*.lot
*.mtc*
*.nav
*.out
*.pdf
*.ps
*.pyg
*.snm
*.toc
*.vrb
labels.pl'

# Set of extensions to ignore for a directory with figures (.eps,
# .dia, or .fig files), generating .pdf files.
pdf='*.pdf'

# Set of files to ignore when using GNU autotools:
auto='autom4te.cache
.deps
config
aclocal.m4
autoscan.log
compile
config.h
config.h.in
config.log
config.status
configure
configure.scan
depcomp
install-sh
Makefile
Makefile.in
missing
stamp-h1'

function main {
    if ! which svn > /dev/null; then
	usage "svn not on path"
    fi

    case $# in
	1 )
	    cfg="$1"; shift
	    dir="."
	    ;;
	2 )
	    cfg="$1"; shift
	    dir="$1"; shift
	    ;;
	* )
	    usage "Wrong number ($#) of arguments"
	    ;;
    esac
#    echo "Args: $cfg/$dir"

    if ! [ -d "$dir" ]; then
	usage "'$dir' is not a directory"
    elif ! [ -d "$dir/.svn" ]; then
	usage "'$dir' is not in Subversion"
#    elif svn proplist "$dir" | grep -qs 'svn:ignore'; then
#	usage "svn:ignore already set on '$dir'"
    fi

    case $cfg in
	tex)
	    if ls $dir | grep -qs '.tex$'; then 
		ignore "$tex" $dir
	    else
		usage "'$dir' does not contain a TeX file"
	    fi
	    ;;
	pdf)
	    ignore "$pdf" $dir
	    ;;
	auto)
	    if [ -f $dir/configure.ac -o -f $dir/Makefile.am ]; then
		ignore "$auto" $dir
	    else
		usage "'$dir' does not contain an Autotools file"
	    fi
	    ;;
	*)
	    usage "'$cfg' not a recognised ignore set"
	    ;;
    esac
}

function usage {
    cat<<EOF >&2
ERROR:
   $1

USAGE:
   svn-ignore <tex|pdf|auto> [dir]

   Sets svn:ignore to a named set ('tex', 'pdf', or 'auto') of
   extensions appropriate to the specified use of 'dir', which
   defaults to the current working directory.

   Use for pdfLaTeX ('tex'), figures ('pdf'), and autotools ('auto')
   is supported.

EOF
   exit 1
}

function ignore {
    echo "$1" > "$tmp"
#    cat "$tmp"
    svn propset svn:ignore -F "$tmp" "$2"
}

# Call main:
main $@

